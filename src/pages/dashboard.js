import React, { useState, useEffect } from 'react';
import { useUser } from '../contexts/UserContext';
import { Container, Row, Col, ButtonGroup, Button, Table } from 'react-bootstrap';
import Head from 'next/head';
import Image from 'next/image';
import { collection, getDocs } from 'firebase/firestore';
import { db } from '../lib/firebase';
import Link from 'next/link';
import { useRouter } from 'next/router';
import styles from '../styles/Dashboard.module.css';

const DashboardPage = () => {
  const { user, loading, logout } = useUser();
  const [items, setItems] = useState([]);
  const router = useRouter(); // Initialize useRouter

  useEffect(() => {
    const fetchItems = async () => {
      const itemsCollection = collection(db, 'items');
      const itemsSnapshot = await getDocs(itemsCollection);
      const itemsList = itemsSnapshot.docs.map(doc => {
        console.log(doc.data());
        return {
          id: doc.id,
          name: doc.data().name,
          description: doc.data().description,
          quantity: doc.data().quantity,
          price: doc.data().price,
          createdAt: doc.data().createdAt ? doc.data().createdAt.toDate() : null,
          updatedAt: doc.data().updatedAt && doc.data().updatedAt.toDate ? doc.data().updatedAt.toDate() : null,
        };
      });
      setItems(itemsList);
    };

    // Refetch the items when the updatedAt query parameter changes
    const handleRouteChange = (url, { shallow }) => {
      if (router.asPath.startsWith('/dashboard') && !shallow) {
        fetchItems();
      }
    };

    router.events.on('routeChangeComplete', handleRouteChange);

    fetchItems();

    const handleView = async () => {
      router.push('/dashboard');
  }
    // Clean up the event listener when the component is unmounted
    return () => {
      router.events.off('routeChangeComplete', handleRouteChange);
    };
  }, [router]);

  const handleEdit = (itemId) => {
    router.push(`/edit/${itemId}`);
  }

  // If the page is still loading, display a loading message
  if (loading) {
    return <div>Loading...</div>;
  }
  // Render the dashboard page with the user's email, a button to add a new item, and a grid view of items
  return <>
    <Head>
      <title>FloralFlow Dashboard</title>
      <meta name="description" content="Generated by create next app" />
      <meta name="viewport" content="width=device-width, initial-scale=1" />
      <link rel="icon" href="/favicon.ico" />
    </Head>
    <Container className={`${styles.main} py-5`}>
      <Row className="justify-content-center">
         
         <Table striped bordered hover>
            <thead>
              <tr>
                <th>Item Name</th>
                <th>Item Description</th>
                <th>Quantity</th>
                <th>Edit</th>
                <th>Last Updated</th>
                <th>Created At</th>
              </tr>
            </thead>
            <tbody>
              {items.map(item => (
                <tr key={item.id}>
                  <td><Link href={`/item/${item.id}`}>{item.name}</Link></td>
                  <td>{item.description}</td>
                  <td>{item.quantity}</td>
                  <td><button
                  onClick={() => handleEdit(item.id)}
                  className={`${styles.button}`}
                  >Edit</button></td>
                 {/*  <td><Link href={`/edit/${item.id}`}>Edit</Link></td> */}
                  <td>{item.updatedAt ? item.updatedAt.toLocaleString() : 'N/A'}</td>
                  <td>{item.createdAt ? item.createdAt.toLocaleString() : 'N/A'}</td>
                </tr>
              ))}
            </tbody>
          </Table>
         
        </Row>
      </Container>
</>;
};

// Style for the images in each item
const imageStyle = {
  maxWidth: '100%',
  height: 'auto',
};

export default DashboardPage;
